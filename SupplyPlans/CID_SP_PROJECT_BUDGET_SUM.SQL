DROP TABLE WARM01.CID_SP_PROJECT_BUDGET_SUM;
CREATE TABLE WARM01.CID_SP_PROJECT_BUDGET_SUM AS
SELECT 
  INVESTMENTS.ID||TO_CHAR(PLAN_VALUES.START_DATE,'YYYYMM') UUID,
  INVESTMENTS.ID INVESTMENT_ID,
  INVESTMENTS.IS_ACTIVE,
  INVESTMENTS.IS_OPEN_FOR_TE,
  PLAN_VALUES.START_DATE DATE_VAL,
  TO_CHAR(PLAN_VALUES.START_DATE,'YYYYMM') DATE_UID,
  SUM(PLAN_VALUES.COSTS) AMOUNT,
  SUM(PLAN_VALUES.UNITS) UNITS
FROM 
  WARM01.INV_INVESTMENTS INVESTMENTS,
  WARM01.FIN_PLANS PLANS,
  WARM01.FIN_COST_PLAN_DETAILS DETAILS,
  (SELECT PRJ_OBJECT_ID,START_DATE,FINISH_DATE,SUM(UNITS) UNITS,SUM(COSTS) COSTS FROM (SELECT PRJ_OBJECT_ID,START_DATE,FINISH_DATE,ROUND((FINISH_DATE-START_DATE)*SUM(SLICE),2) UNITS,0 COSTS,0 ACTUALS FROM WARM01.ODF_SSL_CST_DTL_UNITS GROUP BY PRJ_OBJECT_ID,START_DATE,FINISH_DATE UNION SELECT PRJ_OBJECT_ID,START_DATE,FINISH_DATE,0 UNITS,ROUND((FINISH_DATE-START_DATE)*SUM(SLICE),2) COSTS,0 ACTUALS FROM WARM01.ODF_SSL_CST_DTL_COST GROUP BY PRJ_OBJECT_ID,START_DATE,FINISH_DATE) GROUP BY PRJ_OBJECT_ID,START_DATE,FINISH_DATE) PLAN_VALUES
WHERE 
      INVESTMENTS.ID = PLANS.OBJECT_ID
  AND PLANS.ID = DETAILS.PLAN_ID
  AND DETAILS.ID = PLAN_VALUES.PRJ_OBJECT_ID
  AND INVESTMENTS.ENTITY_CODE = 'CID'
  AND DETAILS.TRANSCLASS_ID = 5000001
  AND INVESTMENTS.ODF_OBJECT_CODE = 'project'
  AND PLANS.PLAN_TYPE_CODE = 'BUDGET'
  AND PLANS.IS_PLAN_OF_RECORD = 1
GROUP BY
  INVESTMENTS.ID,
  INVESTMENTS.IS_ACTIVE,
  INVESTMENTS.IS_OPEN_FOR_TE,
  PLAN_VALUES.START_DATE;